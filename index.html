<!DOCTYPE html>
<html lang="de">
<head>
    <title>rumdiegeln.meme</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Imperial+Script&display=swap" rel="stylesheet">
    <style>
        html, body {
            padding: 0;
            margin: 0;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        svg {
            width: 100dvw;
            height: 100dvh;
        }

        text {
            font-family: "Imperial Script", cursive;
            font-weight: 400;
            font-style: normal;
            font-size: 3rem;
        }

        text tspan {
            fill: transparent;
            stroke: none;
            transition-duration: 0.5s;
            transition-property: fill;
        }
    </style>
</head>
<body>
<svg id="base">
</svg>

<script>
    const baseElement = document.getElementById('base');
    let quotes = [];

    async function loadQuotes() {
        try {
            const response = await fetch('quotes.json');
            const quotesContent = await response.json();

            if (!Array.isArray(quotesContent) || quotesContent.length === 0)
                quotes = ['Invalid quotes response'];
            else
                quotes = quotesContent;
        } catch {
            quotes = ['Error fetching quotes'];
        }
    }

    async function play() {
        await loadQuotes();

        const shownQuote = quotes[Math.floor(quotes.length * Math.random())];

        await writeQuote(shownQuote);
    }

    async function writeQuote(quote) {
        const initialDelay = 500; // delay initial reveal
        const delayPerChar = 50; // 50ms delay per char
        const delayPerUnderscore = 1000; // additional pause while animating
        const maxCharsPerLine = 30;

        let currentDelay = initialDelay;

        const lines = [];
        let charIdx = 0;
        let lineIdx = 0;
        for (const ch of quote) {
            charIdx++;

            if (charIdx > maxCharsPerLine && ch === ' ') {
                lineIdx++;
                charIdx = 0;
                continue;
            }

            lines[lineIdx] ??= '';
            lines[lineIdx] = lines[lineIdx] + ch;
        }

        let currentLineIdx = 0;
        [...lines].forEach(l => {
            const text = addLine(currentLineIdx, lines.length);

            [...l].forEach(ch => {
                if (ch === '_') {
                    currentDelay += delayPerUnderscore;
                    return;
                }


                currentDelay += delayPerChar;
                addChar(text, ch, currentDelay);
            });

            currentLineIdx++;
        });

        setTimeout(() => document.title = quote.replaceAll('_', ''), currentDelay);
        setTimeout(repositionText, initialDelay - 1); // sometimes, the text is not properly positioned
    }

    function addLine(line, maxLines) {
        // <text id="t" x="0" y="50%"></text>
        const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');

        // text should be centered, so middle line must be at 50% (or for even line count, 45/55%)
        // lines are 0-indexed
        const yOffset = 0.5 - (maxLines - 1) * 0.05 + line * 0.1;

        textElement.setAttribute('x', '0');
        textElement.setAttribute('y', `${yOffset * 100}%`);

        baseElement.appendChild(textElement);

        return textElement;
    }

    function addChar(parent, ch, delay) {
        const spanElement = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');

        spanElement.textContent = ch;

        parent.appendChild(spanElement);

        setTimeout(() => requestAnimationFrame(() => {
            spanElement.style.fill = `#000`;
        }), delay);
    }

    function repositionText() {
        requestAnimationFrame(() => {
            for (const textElement of document.getElementsByTagName('text')) {
                const textLength = textElement.getComputedTextLength();

                textElement.setAttribute('x', `${baseElement.scrollWidth / 2 - textLength / 2}px`);
            }
        });
    }

    document.fonts ? document.fonts.ready.then(play) : setTimeout(play, 200);
    window.addEventListener('resize', repositionText);
</script>
</body>
</html>
